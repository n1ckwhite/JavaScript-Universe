# üìå Middleware –≤ Node.js

**Middleware –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Node.js** ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É –ø–æ–ª—É—á–µ–Ω–∏–µ–º HTTP-–∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É. Middleware –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–∞–∫–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞—Ö, –∫–∞–∫ Express.js, –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ—â–Ω—ã–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞–º–∏, –æ—Ç–≤–µ—Ç–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## üîπ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ middleware

### üìå –î–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç–∞–º
- **`req`** ‚Äî –æ–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –¥–∞–Ω–Ω—ã–µ –æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∑–∞–ø—Ä–æ—Å–µ (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∑–∞–≥–æ–ª–æ–≤–∫–∏)
- **`res`** ‚Äî –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—É
- **`next`** ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–º—É middleware –≤ —Ü–µ–ø–æ—á–∫–µ

### üìå –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ middleware
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞**
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∞–º–∏**
- **–†–æ—É—Ç–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤**

### üìå –¶–µ–ø–æ—á–∫–∞ middleware
Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ** –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ï—Å–ª–∏ middleware –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `next()`, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

---

## üîπ –ü—Ä–∏–º–µ—Ä Middleware –≤ Express.js

### üìå –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
```javascript
const express = require('express');
const app = express();

// –ü—Ä–æ—Å—Ç–µ–π—à–∏–π middleware
app.use((req, res, next) => {
    console.log(`${req.method} ${req.url}`);
    next(); // –ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–º—É middleware
});

app.get('/', (req, res) => {
    res.send('Hello, World!');
});

app.listen(3000, () => console.log('–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000'));
```

–≠—Ç–æ—Ç middleware –ª–æ–≥–∏—Ä—É–µ—Ç –º–µ—Ç–æ–¥ –∏ URL –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.

---

## üîπ –¢–∏–ø—ã Middleware

### üìå 1. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ Middleware
Express –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö middleware:

```javascript
app.use(express.json()); // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON
app.use(express.urlencoded({ extended: true })); // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º
app.use(express.static('public')); // –î–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
```

### üìå 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ Middleware
–ü–∏—à—É—Ç—Å—è –≤—Ä—É—á–Ω—É—é –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á:

```javascript
app.use((req, res, next) => {
    if (!req.headers['x-auth-token']) {
        return res.status(401).send('Unauthorized');
    }
    next();
});
```

### üìå 3. Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∞–º–∏. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç 4 –∞—Ä–≥—É–º–µ–Ω—Ç–∞:

```javascript
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).send('Something broke!');
});
```

### üìå 4. Middleware –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
–ü—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º:

```javascript
const checkAuth = (req, res, next) => {
    if (req.query.token === '12345') {
        next();
    } else {
        res.status(403).send('Forbidden');
    }
};

app.get('/protected', checkAuth, (req, res) => {
    res.send('Welcome to the protected route!');
});
```

### üìå 5. –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ Middleware
Express –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫:

```javascript
const morgan = require('morgan');
const helmet = require('helmet');
const cors = require('cors');

app.use(morgan('combined')); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
app.use(helmet()); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
app.use(cors()); // –í–∫–ª—é—á–µ–Ω–∏–µ CORS
```

---

## üîπ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Middleware?

### üìå –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏
Middleware –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `app.use()` –∏–ª–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º.

### üìå –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∏ –±—ã–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.

### üìå –ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
–ï—Å–ª–∏ `next()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Å–ª–µ–¥—É—é—â–µ–º—É middleware. –ï—Å–ª–∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

### üìå –ü—Ä–∏–º–µ—Ä —Ü–µ–ø–æ—á–∫–∏
```javascript
app.use((req, res, next) => {
    console.log('Middleware 1');
    next();
});

app.use((req, res, next) => {
    console.log('Middleware 2');
    next();
});

app.get('/', (req, res) => {
    res.send('Hello, World!');
});

// –õ–æ–≥:
// Middleware 1
// Middleware 2
```

---

## üîπ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å Middleware

### üìå –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **–ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–∏–∫–∏** –≤ middleware ‚Äî –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–¥–Ω—É –∑–∞–¥–∞—á—É
- **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ middleware –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** ‚Äî –æ–±—â–∏–µ –∑–∞–¥–∞—á–∏ –≤—ã—à–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö
- **–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –≤—ã–∑—ã–≤–∞—Ç—å next()** ‚Äî –∏–Ω–∞—á–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å–Ω–µ—Ç

### üìå –°—Ç—Ä—É–∫—Ç—É—Ä–∞ middleware
```javascript
const myMiddleware = (req, res, next) => {
    try {
        // –õ–æ–≥–∏–∫–∞ middleware
        // ...
        next(); // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
    } catch (error) {
        next(error); // –ü–µ—Ä–µ–¥–∞—á–∞ –æ—à–∏–±–∫–∏
    }
};
```

---

## üîπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

### üìå Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```javascript
const logger = (req, res, next) => {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] ${req.method} ${req.url} - ${req.ip}`);
    next();
};

app.use(logger);
```

### üìå Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```javascript
const authenticate = (req, res, next) => {
    const token = req.headers.authorization?.split(' ')[1];
    
    if (!token) {
        return res.status(401).json({ error: '–¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' });
    }
    
    try {
        const decoded = jwt.verify(token, process.env.JWT_SECRET);
        req.user = decoded;
        next();
    } catch (error) {
        res.status(401).json({ error: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω' });
    }
};
```

### üìå Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```javascript
const validateUser = (req, res, next) => {
    const { email, password } = req.body;
    
    if (!email || !password) {
        return res.status(400).json({ error: 'Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }
    
    if (!isValidEmail(email)) {
        return res.status(400).json({ error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email' });
    }
    
    next();
};
```

---

## üéØ –ò—Ç–æ–≥

**Middleware –≤ Node.js** ‚Äî —ç—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ª–µ–≥–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ—Ç–æ–∫–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤. –° –ø–æ–º–æ—â—å—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö middleware –≤—ã –º–æ–∂–µ—Ç–µ —Å—Ç—Ä–æ–∏—Ç—å –≥–∏–±–∫–∏–µ, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
- –û–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –Ω–∞ middleware
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ `next()`
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üèÜ –ó–ê–î–ê–ß–ò

–í–æ—Ç –Ω–∞–±–æ—Ä –∑–∞–¥–∞—á, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å `middleware –≤ Node.js`:

---

### üìå –ó–∞–¥–∞—á–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

‚ùì –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É middleware –¥–ª—è:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ –∏ –∏—Ö —á–∞—Å—Ç–æ—Ç—ã
- –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ API

```javascript
// –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å LoggerMiddleware:
// logRequest(req, res, next) - –ª–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
// trackPerformance(req, res, next) - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
// errorTracker(err, req, res, next) - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
// getStats() - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
// app.use(logger.logRequest);
// app.use(logger.trackPerformance);
// app.use(logger.errorTracker);
```

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
class LoggerMiddleware {
    constructor(options = {}) {
        this.logs = [];
        this.stats = {
            totalRequests: 0,
            errors: 0,
            averageResponseTime: 0,
            requestsByMethod: {},
            requestsByStatus: {},
            errorsByType: {}
        };
        this.maxLogs = options.maxLogs || 1000;
        this.enableConsole = options.enableConsole !== false;
    }

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
    logRequest(req, res, next) {
        const startTime = Date.now();
        const requestId = this.generateRequestId();
        
        // –î–æ–±–∞–≤–ª—è–µ–º ID –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        req.requestId = requestId;
        
        // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        const logEntry = {
            id: requestId,
            timestamp: new Date().toISOString(),
            method: req.method,
            url: req.url,
            ip: req.ip || req.connection.remoteAddress,
            userAgent: req.get('User-Agent'),
            startTime: startTime,
            status: null,
            responseTime: null,
            error: null
        };

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const originalSend = res.send;
        const originalJson = res.json;
        
        res.send = function(data) {
            logEntry.status = res.statusCode;
            logEntry.responseTime = Date.now() - startTime;
            this.logRequestComplete(logEntry);
            return originalSend.call(this, data);
        }.bind(this);

        res.json = function(data) {
            logEntry.status = res.statusCode;
            logEntry.responseTime = Date.now() - startTime;
            this.logRequestComplete(logEntry);
            return originalJson.call(this, data);
        }.bind(this);

        if (this.enableConsole) {
            console.log(`üìù [${requestId}] ${req.method} ${req.url} - ${req.ip}`);
        }

        next();
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    trackPerformance(req, res, next) {
        const startTime = process.hrtime.bigint();
        
        res.on('finish', () => {
            const endTime = process.hrtime.bigint();
            const duration = Number(endTime - startTime) / 1000000; // –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            
            this.updatePerformanceStats(duration, req.method, res.statusCode);
            
            if (duration > 1000) { // –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                console.warn(`‚ö†Ô∏è  –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: ${req.method} ${req.url} - ${duration.toFixed(2)}ms`);
            }
        });

        next();
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
    errorTracker(err, req, res, next) {
        const errorLog = {
            id: req.requestId || this.generateRequestId(),
            timestamp: new Date().toISOString(),
            error: {
                message: err.message,
                stack: err.stack,
                name: err.name
            },
            request: {
                method: req.method,
                url: req.url,
                ip: req.ip,
                userAgent: req.get('User-Agent')
            }
        };

        this.logs.push(errorLog);
        this.stats.errors++;
        this.stats.errorsByType[err.name] = (this.stats.errorsByType[err.name] || 0) + 1;

        if (this.enableConsole) {
            console.error(`‚ùå [${errorLog.id}] –û—à–∏–±–∫–∞: ${err.message}`);
        }

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
        if (this.logs.length > this.maxLogs) {
            this.logs.shift();
        }

        res.status(500).json({
            error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
            requestId: errorLog.id
        });
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    logRequestComplete(logEntry) {
        this.logs.push(logEntry);
        this.stats.totalRequests++;
        this.stats.requestsByMethod[logEntry.method] = (this.stats.requestsByMethod[logEntry.method] || 0) + 1;
        this.stats.requestsByStatus[logEntry.status] = (this.stats.requestsByStatus[logEntry.status] || 0) + 1;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
        this.updateAverageResponseTime(logEntry.responseTime);

        if (this.enableConsole) {
            const statusEmoji = logEntry.status >= 400 ? '‚ùå' : '‚úÖ';
            console.log(`${statusEmoji} [${logEntry.id}] ${logEntry.method} ${logEntry.url} - ${logEntry.status} (${logEntry.responseTime}ms)`);
        }

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
        if (this.logs.length > this.maxLogs) {
            this.logs.shift();
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    updatePerformanceStats(duration, method, status) {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if (duration > 5000) { // –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            console.error(`üêå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: ${method} - ${duration.toFixed(2)}ms`);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
    updateAverageResponseTime(responseTime) {
        const totalRequests = this.stats.totalRequests;
        const currentAverage = this.stats.averageResponseTime;
        
        this.stats.averageResponseTime = 
            (currentAverage * (totalRequests - 1) + responseTime) / totalRequests;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –∑–∞–ø—Ä–æ—Å–∞
    generateRequestId() {
        return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    getStats() {
        const recentLogs = this.logs.filter(log => 
            new Date(log.timestamp) > new Date(Date.now() - 24 * 60 * 60 * 1000)
        );

        return {
            ...this.stats,
            recentRequests: recentLogs.length,
            topErrors: this.getTopErrors(),
            performanceMetrics: this.getPerformanceMetrics()
        };
    }

    // –¢–æ–ø –æ—à–∏–±–æ–∫
    getTopErrors() {
        return Object.entries(this.stats.errorsByType)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5)
            .map(([error, count]) => ({ error, count }));
    }

    // –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    getPerformanceMetrics() {
        const recentLogs = this.logs.filter(log => 
            log.responseTime && 
            new Date(log.timestamp) > new Date(Date.now() - 60 * 60 * 1000) // –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
        );

        if (recentLogs.length === 0) return {};

        const responseTimes = recentLogs.map(log => log.responseTime);
        const sortedTimes = responseTimes.sort((a, b) => a - b);

        return {
            min: Math.min(...responseTimes),
            max: Math.max(...responseTimes),
            median: sortedTimes[Math.floor(sortedTimes.length / 2)],
            p95: sortedTimes[Math.floor(sortedTimes.length * 0.95)],
            p99: sortedTimes[Math.floor(sortedTimes.length * 0.99)]
        };
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤
    exportLogs(format = 'json') {
        if (format === 'json') {
            return JSON.stringify(this.logs, null, 2);
        } else if (format === 'csv') {
            return this.logsToCSV();
        }
        throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç');
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ CSV
    logsToCSV() {
        if (this.logs.length === 0) return '';

        const headers = ['id', 'timestamp', 'method', 'url', 'ip', 'status', 'responseTime'];
        const csvRows = [headers.join(',')];

        this.logs.forEach(log => {
            const row = headers.map(header => {
                const value = log[header] || '';
                return `"${value.toString().replace(/"/g, '""')}"`;
            });
            csvRows.push(row.join(','));
        });

        return csvRows.join('\n');
    }

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
    cleanup(olderThan = 7 * 24 * 60 * 60 * 1000) { // 7 –¥–Ω–µ–π
        const cutoff = new Date(Date.now() - olderThan);
        const initialCount = this.logs.length;
        
        this.logs = this.logs.filter(log => new Date(log.timestamp) > cutoff);
        
        const removedCount = initialCount - this.logs.length;
        console.log(`üßπ –û—á–∏—â–µ–Ω–æ ${removedCount} —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤`);
        
        return removedCount;
    }
}

// –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
const logger = new LoggerMiddleware({ enableConsole: true });

const express = require('express');
const app = express();

// –ü—Ä–∏–º–µ–Ω—è–µ–º middleware
app.use(logger.logRequest);
app.use(logger.trackPerformance);

// –ú–∞—Ä—à—Ä—É—Ç—ã
app.get('/', (req, res) => {
    res.json({ message: '–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!', requestId: req.requestId });
});

app.get('/slow', (req, res) => {
    setTimeout(() => {
        res.json({ message: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å', requestId: req.requestId });
    }, 2000);
});

app.get('/error', (req, res, next) => {
    next(new Error('–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞'));
});

// Middleware –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
app.use(logger.errorTracker);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
app.get('/stats', (req, res) => {
    res.json(logger.getStats());
});

module.exports = LoggerMiddleware;
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

‚ùì –°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è:
- –ü—Ä–æ–≤–µ—Ä–∫–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
- –ö–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º
- –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (admin, user, guest)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞

```javascript
// –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å AuthMiddleware:
// verifyToken(req, res, next) - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT —Ç–æ–∫–µ–Ω
// requireRole(role) - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// requireAuth(req, res, next) - —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
// logAccess(req, res, next) - –ª–æ–≥–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
// app.use(auth.verifyToken);
// app.get('/admin', auth.requireRole('admin'), adminHandler);
// app.get('/profile', auth.requireAuth, profileHandler);
```

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const jwt = require('jsonwebtoken');

class AuthMiddleware {
    constructor(options = {}) {
        this.jwtSecret = options.jwtSecret || process.env.JWT_SECRET || 'your-secret-key';
        this.accessLogs = [];
        this.maxLogs = options.maxLogs || 1000;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
    verifyToken(req, res, next) {
        const authHeader = req.headers.authorization;
        
        if (!authHeader || !authHeader.startsWith('Bearer ')) {
            return res.status(401).json({
                success: false,
                message: '–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω'
            });
        }

        const token = authHeader.substring(7);
        
        try {
            const decoded = jwt.verify(token, this.jwtSecret);
            req.user = decoded;
            next();
        } catch (error) {
            this.logAccess(req, 'token_invalid', { error: error.message });
            return res.status(401).json({
                success: false,
                message: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω'
            });
        }
    }

    // –¢—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    requireAuth(req, res, next) {
        if (!req.user) {
            this.logAccess(req, 'auth_required');
            return res.status(401).json({
                success: false,
                message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è'
            });
        }
        next();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    requireRole(requiredRole) {
        return (req, res, next) => {
            if (!req.user) {
                this.logAccess(req, 'auth_required');
                return res.status(401).json({
                    success: false,
                    message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è'
                });
            }

            const userRole = req.user.role || 'guest';
            const roleHierarchy = { guest: 0, user: 1, moderator: 2, admin: 3 };
            
            if (roleHierarchy[userRole] < roleHierarchy[requiredRole]) {
                this.logAccess(req, 'insufficient_role', { 
                    required: requiredRole, 
                    current: userRole 
                });
                return res.status(403).json({
                    success: false,
                    message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å: ${requiredRole}`
                });
            }

            this.logAccess(req, 'access_granted', { role: userRole });
            next();
        };
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π
    requireAnyRole(roles) {
        return (req, res, next) => {
            if (!req.user) {
                this.logAccess(req, 'auth_required');
                return res.status(401).json({
                    success: false,
                    message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è'
                });
            }

            const userRole = req.user.role || 'guest';
            
            if (!roles.includes(userRole)) {
                this.logAccess(req, 'insufficient_role', { 
                    required: roles, 
                    current: userRole 
                });
                return res.status(403).json({
                    success: false,
                    message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–¥–Ω–∞ –∏–∑ —Ä–æ–ª–µ–π: ${roles.join(', ')}`
                });
            }

            this.logAccess(req, 'access_granted', { role: userRole });
            next();
        };
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–º
    requireOwnership(field = 'userId') {
        return (req, res, next) => {
            if (!req.user) {
                this.logAccess(req, 'auth_required');
                return res.status(401).json({
                    success: false,
                    message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è'
                });
            }

            const resourceUserId = req.params[field] || req.body[field];
            const currentUserId = req.user.userId;

            if (resourceUserId !== currentUserId && req.user.role !== 'admin') {
                this.logAccess(req, 'ownership_denied', { 
                    resourceOwner: resourceUserId, 
                    currentUser: currentUserId 
                });
                return res.status(403).json({
                    success: false,
                    message: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã'
                });
            }

            this.logAccess(req, 'ownership_granted');
            next();
        };
    }

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞
    logAccess(req, action, details = {}) {
        const logEntry = {
            id: this.generateLogId(),
            timestamp: new Date().toISOString(),
            action,
            user: req.user ? {
                id: req.user.userId,
                email: req.user.email,
                role: req.user.role
            } : null,
            request: {
                method: req.method,
                url: req.url,
                ip: req.ip,
                userAgent: req.get('User-Agent')
            },
            details
        };

        this.accessLogs.push(logEntry);

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
        if (this.accessLogs.length > this.maxLogs) {
            this.accessLogs.shift();
        }

        // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
        const statusEmoji = action.includes('denied') || action.includes('required') ? '‚ùå' : '‚úÖ';
        console.log(`${statusEmoji} [${logEntry.id}] ${action} - ${req.method} ${req.url}`);
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ª–æ–≥–∞
    generateLogId() {
        return `auth_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –∫–ª—é—á–∞
    requireApiKey(apiKey = process.env.API_KEY) {
        return (req, res, next) => {
            const providedKey = req.headers['x-api-key'];
            
            if (!providedKey) {
                this.logAccess(req, 'api_key_missing');
                return res.status(401).json({
                    success: false,
                    message: 'API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω'
                });
            }

            if (providedKey !== apiKey) {
                this.logAccess(req, 'api_key_invalid');
                return res.status(401).json({
                    success: false,
                    message: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π API –∫–ª—é—á'
                });
            }

            this.logAccess(req, 'api_key_valid');
            next();
        };
    }

    // Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ IP
    allowIPs(allowedIPs) {
        return (req, res, next) => {
            const clientIP = req.ip || req.connection.remoteAddress;
            
            if (!allowedIPs.includes(clientIP)) {
                this.logAccess(req, 'ip_blocked', { clientIP, allowedIPs });
                return res.status(403).json({
                    success: false,
                    message: '–î–æ—Å—Ç—É–ø —Å –≤–∞—à–µ–≥–æ IP –∑–∞–ø—Ä–µ—â–µ–Ω'
                });
            }

            this.logAccess(req, 'ip_allowed', { clientIP });
            next();
        };
    }

    // Middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    allowTimeWindow(startHour, endHour) {
        return (req, res, next) => {
            const now = new Date();
            const currentHour = now.getHours();
            
            if (currentHour < startHour || currentHour >= endHour) {
                this.logAccess(req, 'time_restricted', { 
                    currentHour, 
                    allowedWindow: `${startHour}-${endHour}` 
                });
                return res.status(403).json({
                    success: false,
                    message: `–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Å ${startHour}:00 –¥–æ ${endHour}:00`
                });
            }

            this.logAccess(req, 'time_allowed', { currentHour });
            next();
        };
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞
    getAccessStats() {
        const stats = {
            totalLogs: this.accessLogs.length,
            byAction: {},
            byUser: {},
            byIP: {},
            recentActivity: this.accessLogs.slice(-50)
        };

        this.accessLogs.forEach(log => {
            stats.byAction[log.action] = (stats.byAction[log.action] || 0) + 1;
            
            if (log.user) {
                stats.byUser[log.user.email] = (stats.byUser[log.user.email] || 0) + 1;
            }
            
            stats.byIP[log.request.ip] = (stats.byIP[log.request.ip] || 0) + 1;
        });

        return stats;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    getSuspiciousActivity() {
        const suspiciousIPs = Object.entries(this.getAccessStats().byIP)
            .filter(([ip, count]) => count > 10)
            .sort(([,a], [,b]) => b - a);

        const failedAttempts = this.accessLogs.filter(log => 
            log.action.includes('denied') || log.action.includes('invalid')
        );

        return {
            suspiciousIPs,
            failedAttempts: failedAttempts.length,
            recentFailures: failedAttempts.slice(-10)
        };
    }
}

// –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
const auth = new AuthMiddleware({
    jwtSecret: 'super-secret-key',
    maxLogs: 500
});

const express = require('express');
const app = express();

app.use(express.json());

// –ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/', (req, res) => {
    res.json({ message: '–ü—É–±–ª–∏—á–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç' });
});

// –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/profile', auth.verifyToken, auth.requireAuth, (req, res) => {
    res.json({ 
        message: '–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 
        user: req.user 
    });
});

app.get('/admin', auth.verifyToken, auth.requireRole('admin'), (req, res) => {
    res.json({ message: '–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å' });
});

app.get('/moderator', auth.verifyToken, auth.requireAnyRole(['moderator', 'admin']), (req, res) => {
    res.json({ message: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –ø–∞–Ω–µ–ª—å' });
});

// API —Å –∫–ª—é—á–æ–º
app.get('/api/data', auth.requireApiKey(), (req, res) => {
    res.json({ message: '–î–∞–Ω–Ω—ã–µ API' });
});

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞
app.get('/auth/stats', auth.verifyToken, auth.requireRole('admin'), (req, res) => {
    res.json(auth.getAccessStats());
});

module.exports = AuthMiddleware;
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

‚ùì –°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è:
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API
- –°–∂–∞—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```javascript
// –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å CacheMiddleware:
// cacheResponse(ttl) - –∫—ç—à–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã
// compressResponse(req, res, next) - —Å–∂–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
// rateLimit(limit, window) - –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
// optimizeResponse(req, res, next) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
// app.use(cache.cacheResponse(300)); // 5 –º–∏–Ω—É—Ç
// app.use(cache.compressResponse);
// app.use(cache.rateLimit(100, 60000)); // 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
```

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const zlib = require('zlib');
const crypto = require('crypto');

class CacheMiddleware {
    constructor(options = {}) {
        this.cache = new Map();
        this.rateLimits = new Map();
        this.compressionThreshold = options.compressionThreshold || 1024; // 1KB
        this.maxCacheSize = options.maxCacheSize || 1000;
        this.cleanupInterval = options.cleanupInterval || 60000; // 1 –º–∏–Ω—É—Ç–∞
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–∏—Å—Ç–∫—É –∫—ç—à–∞
        this.startCleanup();
    }

    // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
    cacheResponse(ttl = 300) { // 5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return (req, res, next) => {
            const cacheKey = this.generateCacheKey(req);
            const cached = this.cache.get(cacheKey);

            if (cached && this.isCacheValid(cached, ttl)) {
                console.log(`üíæ –ö—ç—à HIT: ${req.method} ${req.url}`);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                Object.entries(cached.headers).forEach(([key, value]) => {
                    res.setHeader(key, value);
                });
                
                return res.status(cached.status).send(cached.data);
            }

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
            const originalSend = res.send;
            const originalJson = res.json;
            const originalEnd = res.end;

            const responseData = {
                status: null,
                headers: {},
                data: null,
                timestamp: Date.now()
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            const originalSetHeader = res.setHeader;
            res.setHeader = function(name, value) {
                responseData.headers[name] = value;
                return originalSetHeader.call(this, name, value);
            };

            res.send = function(data) {
                responseData.status = res.statusCode;
                responseData.data = data;
                this.cacheResponse(cacheKey, responseData);
                return originalSend.call(this, data);
            }.bind(this);

            res.json = function(data) {
                responseData.status = res.statusCode;
                responseData.data = JSON.stringify(data);
                this.cacheResponse(cacheKey, responseData);
                return originalJson.call(this, data);
            }.bind(this);

            res.end = function(data) {
                if (data) {
                    responseData.status = res.statusCode;
                    responseData.data = data;
                    this.cacheResponse(cacheKey, responseData);
                }
                return originalEnd.call(this, data);
            }.bind(this);

            next();
        };
    }

    // –°–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
    compressResponse(req, res, next) {
        const acceptEncoding = req.headers['accept-encoding'] || '';
        
        if (!acceptEncoding.includes('gzip') && !acceptEncoding.includes('deflate')) {
            return next();
        }

        const originalSend = res.send;
        const originalJson = res.json;

        res.send = function(data) {
            if (typeof data === 'string' && data.length > this.compressionThreshold) {
                this.compressData(data, acceptEncoding, res, originalSend);
            } else {
                originalSend.call(this, data);
            }
        }.bind(this);

        res.json = function(data) {
            const jsonData = JSON.stringify(data);
            if (jsonData.length > this.compressionThreshold) {
                this.compressData(jsonData, acceptEncoding, res, originalJson);
            } else {
                originalJson.call(this, data);
            }
        }.bind(this);

        next();
    }

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
    rateLimit(limit = 100, windowMs = 60000) { // 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
        return (req, res, next) => {
            const key = req.ip || req.connection.remoteAddress;
            const now = Date.now();
            const windowStart = now - windowMs;

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
            if (!this.rateLimits.has(key)) {
                this.rateLimits.set(key, []);
            }

            const requests = this.rateLimits.get(key);
            const recentRequests = requests.filter(timestamp => timestamp > windowStart);
            
            if (recentRequests.length >= limit) {
                console.warn(`‚ö†Ô∏è  Rate limit exceeded for ${key}`);
                return res.status(429).json({
                    success: false,
                    message: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤',
                    retryAfter: Math.ceil(windowMs / 1000)
                });
            }

            recentRequests.push(now);
            this.rateLimits.set(key, recentRequests);

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ª–∏–º–∏—Ç–∞—Ö
            res.setHeader('X-RateLimit-Limit', limit);
            res.setHeader('X-RateLimit-Remaining', limit - recentRequests.length);
            res.setHeader('X-RateLimit-Reset', new Date(now + windowMs).toISOString());

            next();
        };
    }

    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
    optimizeResponse(req, res, next) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        if (req.method === 'GET') {
            res.setHeader('Cache-Control', 'public, max-age=300'); // 5 –º–∏–Ω—É—Ç
            res.setHeader('ETag', this.generateETag(req.url));
        }

        // –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Ä–∞—Å–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ
        res.removeHeader('X-Powered-By');
        res.removeHeader('Server');

        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        res.setHeader('X-Content-Type-Options', 'nosniff');
        res.setHeader('X-Frame-Options', 'DENY');
        res.setHeader('X-XSS-Protection', '1; mode=block');

        next();
    }

    // Middleware –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    preloadData(dataLoader) {
        return (req, res, next) => {
            const cacheKey = this.generateCacheKey(req);
            
            if (!this.cache.has(cacheKey)) {
                dataLoader(req)
                    .then(data => {
                        this.cache.set(cacheKey, {
                            data: JSON.stringify(data),
                            status: 200,
                            headers: { 'Content-Type': 'application/json' },
                            timestamp: Date.now()
                        });
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    });
            }
            
            next();
        };
    }

    // Middleware –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
    invalidateCache(pattern) {
        return (req, res, next) => {
            const originalSend = res.send;
            const originalJson = res.json;

            res.send = function(data) {
                this.invalidateCacheByPattern(pattern);
                return originalSend.call(this, data);
            }.bind(this);

            res.json = function(data) {
                this.invalidateCacheByPattern(pattern);
                return originalJson.call(this, data);
            }.bind(this);

            next();
        };
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    generateCacheKey(req) {
        const keyData = {
            method: req.method,
            url: req.url,
            query: req.query,
            body: req.body
        };
        return crypto.createHash('md5').update(JSON.stringify(keyData)).digest('hex');
    }

    generateETag(url) {
        return `"${crypto.createHash('md5').update(url).digest('hex')}"`;
    }

    isCacheValid(cached, ttl) {
        return Date.now() - cached.timestamp < ttl * 1000;
    }

    cacheResponse(key, data) {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
        if (this.cache.size >= this.maxCacheSize) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        
        this.cache.set(key, data);
    }

    compressData(data, acceptEncoding, res, originalMethod) {
        if (acceptEncoding.includes('gzip')) {
            res.setHeader('Content-Encoding', 'gzip');
            zlib.gzip(data, (err, compressed) => {
                if (err) {
                    originalMethod.call(res, data);
                } else {
                    originalMethod.call(res, compressed);
                }
            });
        } else if (acceptEncoding.includes('deflate')) {
            res.setHeader('Content-Encoding', 'deflate');
            zlib.deflate(data, (err, compressed) => {
                if (err) {
                    originalMethod.call(res, data);
                } else {
                    originalMethod.call(res, compressed);
                }
            });
        } else {
            originalMethod.call(res, data);
        }
    }

    invalidateCacheByPattern(pattern) {
        const regex = new RegExp(pattern);
        for (const [key, value] of this.cache.entries()) {
            if (regex.test(value.data)) {
                this.cache.delete(key);
                console.log(`üóëÔ∏è  –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω: ${key}`);
            }
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
    startCleanup() {
        setInterval(() => {
            this.cleanup();
        }, this.cleanupInterval);
    }

    cleanup() {
        const now = Date.now();
        let cleaned = 0;

        // –û—á–∏—â–∞–µ–º –∫—ç—à
        for (const [key, value] of this.cache.entries()) {
            if (now - value.timestamp > 24 * 60 * 60 * 1000) { // 24 —á–∞—Å–∞
                this.cache.delete(key);
                cleaned++;
            }
        }

        // –û—á–∏—â–∞–µ–º rate limits
        for (const [key, requests] of this.rateLimits.entries()) {
            const recentRequests = requests.filter(timestamp => now - timestamp < 60 * 60 * 1000); // 1 —á–∞—Å
            if (recentRequests.length === 0) {
                this.rateLimits.delete(key);
            } else {
                this.rateLimits.set(key, recentRequests);
            }
        }

        if (cleaned > 0) {
            console.log(`üßπ –û—á–∏—â–µ–Ω–æ ${cleaned} —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∫—ç—à–∞`);
        }
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
    getCacheStats() {
        return {
            cacheSize: this.cache.size,
            rateLimitEntries: this.rateLimits.size,
            hitRate: this.calculateHitRate(),
            memoryUsage: this.estimateMemoryUsage()
        };
    }

    calculateHitRate() {
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å hits/misses
        return Math.random() * 100; // –ó–∞–≥–ª—É—à–∫–∞
    }

    estimateMemoryUsage() {
        let totalSize = 0;
        for (const [key, value] of this.cache.entries()) {
            totalSize += key.length + JSON.stringify(value).length;
        }
        return totalSize;
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ –∫—ç—à–∞
    clearCache() {
        this.cache.clear();
        this.rateLimits.clear();
        console.log('üóëÔ∏è  –í–µ—Å—å –∫—ç—à –æ—á–∏—â–µ–Ω');
    }
}

// –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
const cache = new CacheMiddleware({
    compressionThreshold: 512,
    maxCacheSize: 500,
    cleanupInterval: 30000
});

const express = require('express');
const app = express();

app.use(express.json());

// –ü—Ä–∏–º–µ–Ω—è–µ–º middleware
app.use(cache.optimizeResponse);
app.use(cache.compressResponse);
app.use(cache.rateLimit(50, 60000)); // 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/api/users', cache.cacheResponse(300), (req, res) => {
    // –°–∏–º—É–ª—è—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    setTimeout(() => {
        res.json({ 
            users: [
                { id: 1, name: '–ò–≤–∞–Ω' },
                { id: 2, name: '–ú–∞—Ä–∏—è' }
            ],
            timestamp: new Date().toISOString()
        });
    }, 1000);
});

app.get('/api/posts', cache.cacheResponse(600), (req, res) => {
    res.json({ 
        posts: [
            { id: 1, title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1' },
            { id: 2, title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2' }
        ]
    });
});

// –ú–∞—Ä—à—Ä—É—Ç —Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∫—ç—à–∞
app.post('/api/posts', cache.invalidateCache('posts'), (req, res) => {
    res.json({ message: '–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω', id: Date.now() });
});

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
app.get('/cache/stats', (req, res) => {
    res.json(cache.getCacheStats());
});

// –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
app.delete('/cache', (req, res) => {
    cache.clearCache();
    res.json({ message: '–ö—ç—à –æ—á–∏—â–µ–Ω' });
});

module.exports = CacheMiddleware;
```

</details>

---

üéâ –≠—Ç–∏ –∑–∞–¥–∞—á–∏ –ø–æ–º–æ–≥—É—Ç –ø–æ–Ω—è—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å middleware –≤ Node.js –∏ –Ω–∞—É—á–∏—Ç—å—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

---
