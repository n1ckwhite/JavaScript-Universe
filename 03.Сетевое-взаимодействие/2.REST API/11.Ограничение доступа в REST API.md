# üìå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –≤ REST API: –º–µ—Ç–æ–¥—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –º–µ—Ç–æ–¥–∞–º –∏–ª–∏ —Ä–µ—Å—É—Ä—Å–∞–º –≤ REST API ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –∞—Å–ø–µ–∫—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –∑–∞—â–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.

## üîπ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—é –¥–æ—Å—Ç—É–ø–∞

### 1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
–ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫—Ç–æ –≤—ã).

#### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
–ü—Ä–æ—Ü–µ—Å—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (—á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å).

#### ‚úç –ü—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
```javascript
const jwt = require('jsonwebtoken');

const authenticateToken = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};
```

---

### 2. **–†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞**

#### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞.

#### ‚úç –ü—Ä–∏–º–µ—Ä —Ä–æ–ª–µ–≤–æ–π –º–æ–¥–µ–ª–∏:
```javascript
const roles = {
  GUEST: 'guest',
  USER: 'user',
  MODERATOR: 'moderator',
  ADMIN: 'admin'
};

const permissions = {
  [roles.GUEST]: ['read:public'],
  [roles.USER]: ['read:public', 'read:own', 'write:own'],
  [roles.MODERATOR]: ['read:public', 'read:own', 'write:own', 'moderate:content'],
  [roles.ADMIN]: ['read:all', 'write:all', 'delete:all', 'manage:users']
};
```

#### Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
```javascript
const checkRole = (requiredRole) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    const userRole = req.user.role;
    const userPermissions = permissions[userRole] || [];
    
    if (!userPermissions.includes(requiredRole)) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    
    next();
  };
};
```

---

### 3. **Middleware –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞**

#### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º
–°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.

#### ‚úç –ü—Ä–∏–º–µ—Ä middleware:
```javascript
const express = require('express');
const app = express();

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
const requireAuth = (req, res, next) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Authentication required' });
  }
  next();
};

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const requireAdmin = (req, res, next) => {
  if (req.user.role !== 'admin') {
    return res.status(403).json({ error: 'Admin access required' });
  }
  next();
};

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞
const requireOwnership = (resourceType) => {
  return (req, res, next) => {
    const resourceId = req.params.id;
    const userId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ —Ä–µ—Å—É—Ä—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if (req.user.role !== 'admin' && req.user.id !== resourceId) {
      return res.status(403).json({ error: 'Access denied' });
    }
    
    next();
  };
};
```

---

### 4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏**

#### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—è–º –¥–æ—Å—Ç—É–ø–∞
–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞.

#### ‚úç –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤:
```javascript
// –ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã (–¥–æ—Å—Ç—É–ø –¥–ª—è –≤—Å–µ—Ö)
app.get('/api/public/posts', (req, res) => {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
});

// –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
app.get('/api/posts', authenticateToken, (req, res) => {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
});

app.post('/api/posts', authenticateToken, (req, res) => {
  // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
});

// –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
app.get('/api/admin/users', authenticateToken, requireAdmin, (req, res) => {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
});

app.delete('/api/admin/users/:id', authenticateToken, requireAdmin, (req, res) => {
  // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
});

// –ú–∞—Ä—à—Ä—É—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
app.put('/api/posts/:id', authenticateToken, requireOwnership('post'), (req, res) => {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)
});
```

---

### 5. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ HTTP –º–µ—Ç–æ–¥–∞–º**

#### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º HTTP –º–µ—Ç–æ–¥–∞–º.

#### ‚úç –ü—Ä–∏–º–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤:
```javascript
const allowedMethods = {
  '/api/posts': ['GET', 'POST'],
  '/api/posts/:id': ['GET', 'PUT', 'DELETE'],
  '/api/admin/users': ['GET', 'POST', 'PUT', 'DELETE']
};

const checkMethod = (req, res, next) => {
  const path = req.route?.path || req.path;
  const method = req.method;
  
  const allowed = allowedMethods[path];
  if (allowed && !allowed.includes(method)) {
    return res.status(405).json({ 
      error: `Method ${method} not allowed for ${path}` 
    });
  }
  
  next();
};

app.use(checkMethod);
```

---

### 6. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞**

#### –£—Å–ª–æ–≤–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

#### ‚úç –ü—Ä–∏–º–µ—Ä —É—Å–ª–æ–≤–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```javascript
const checkResourceAccess = (resourceType) => {
  return async (req, res, next) => {
    const resourceId = req.params.id;
    const userId = req.user.id;
    
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Å—É—Ä—Å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      const resource = await Resource.findById(resourceId);
      
      if (!resource) {
        return res.status(404).json({ error: 'Resource not found' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
      const hasAccess = 
        req.user.role === 'admin' ||
        resource.userId === userId ||
        (resource.isPublic && req.method === 'GET');
      
      if (!hasAccess) {
        return res.status(403).json({ error: 'Access denied' });
      }
      
      req.resource = resource;
      next();
    } catch (error) {
      return res.status(500).json({ error: 'Server error' });
    }
  };
};
```

---

### 7. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

#### ‚úç –ü—Ä–∏–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:
```javascript
const getUserPosts = async (req, res) => {
  const userId = req.user.id;
  const userRole = req.user.role;
  
  try {
    let query = {};
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    if (userRole === 'admin') {
      // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ –ø–æ—Å—Ç—ã
      query = {};
    } else if (userRole === 'moderator') {
      // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –ø—É–±–ª–∏—á–Ω—ã–µ –ø–æ—Å—Ç—ã –∏ —Å–≤–æ–∏
      query = {
        $or: [
          { isPublic: true },
          { userId: userId }
        ]
      };
    } else {
      // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø–æ—Å—Ç—ã
      query = { userId: userId };
    }
    
    const posts = await Post.find(query);
    res.json(posts);
  } catch (error) {
    res.status(500).json({ error: 'Server error' });
  }
};
```

---

### 8. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ IP –∏ CORS**

#### IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –ø–æ IP-–∞–¥—Ä–µ—Å–∞–º.

#### ‚úç –ü—Ä–∏–º–µ—Ä IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:
```javascript
const allowedIPs = ['192.168.1.1', '10.0.0.1'];

const checkIP = (req, res, next) => {
  const clientIP = req.ip || req.connection.remoteAddress;
  
  if (!allowedIPs.includes(clientIP)) {
    return res.status(403).json({ error: 'IP not allowed' });
  }
  
  next();
};

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º
app.use('/api/admin', checkIP);
```

#### CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É –º–µ–∂–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

#### ‚úç –ü—Ä–∏–º–µ—Ä CORS:
```javascript
const cors = require('cors');

const corsOptions = {
  origin: (origin, callback) => {
    const allowedOrigins = [
      'https://yourdomain.com',
      'https://app.yourdomain.com'
    ];
    
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
};

app.use(cors(corsOptions));
```

---

### 9. **API Gateway –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º**

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API Gateway
–°–æ–∑–¥–∞–π—Ç–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º.

#### ‚úç –ü—Ä–∏–º–µ—Ä API Gateway:
```javascript
const express = require('express');
const rateLimit = require('express-rate-limit');

const gateway = express();

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  max: 100 // –º–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤
});

gateway.use(limiter);

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
gateway.use('/api', authenticateToken);

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º
gateway.use('/api/admin', requireRole('admin'));
gateway.use('/api/moderator', requireRole(['admin', 'moderator']));

// –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º
gateway.use('/api/users', proxy('http://user-service:3001'));
gateway.use('/api/posts', proxy('http://post-service:3002'));
gateway.use('/api/admin', proxy('http://admin-service:3003'));
```

---

## üîπ –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ó–∞—â–∏—â—ë–Ω–Ω—ã–π REST API —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –¥–æ—Å—Ç—É–ø–∞

#### ‚úç Express.js —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –¥–æ—Å—Ç—É–ø–∞:
```javascript
const express = require('express');
const jwt = require('jsonwebtoken');
const cors = require('cors');
const rateLimit = require('express-rate-limit');

const app = express();

// Middleware
app.use(express.json());
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
  credentials: true
}));

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
});
app.use('/api/', limiter);

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è middleware
const authenticateToken = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
const requireRole = (roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    const userRole = req.user.role;
    const allowedRoles = Array.isArray(roles) ? roles : [roles];
    
    if (!allowedRoles.includes(userRole)) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    
    next();
  };
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞
const requireOwnership = (resourceType) => {
  return async (req, res, next) => {
    const resourceId = req.params.id;
    const userId = req.user.id;
    
    try {
      // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
      // –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      const resource = await getResourceById(resourceId, resourceType);
      
      if (!resource) {
        return res.status(404).json({ error: 'Resource not found' });
      }
      
      if (req.user.role !== 'admin' && resource.userId !== userId) {
        return res.status(403).json({ error: 'Access denied' });
      }
      
      req.resource = resource;
      next();
    } catch (error) {
      return res.status(500).json({ error: 'Server error' });
    }
  };
};

// –ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/api/public/posts', (req, res) => {
  res.json({ message: 'Public posts available to everyone' });
});

// –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
app.get('/api/posts', authenticateToken, (req, res) => {
  res.json({ message: 'User posts', userId: req.user.id });
});

app.post('/api/posts', authenticateToken, (req, res) => {
  res.json({ message: 'Post created', userId: req.user.id });
});

// –ú–∞—Ä—à—Ä—É—Ç—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
app.put('/api/posts/:id', authenticateToken, requireOwnership('post'), (req, res) => {
  res.json({ message: 'Post updated', resource: req.resource });
});

app.delete('/api/posts/:id', authenticateToken, requireOwnership('post'), (req, res) => {
  res.json({ message: 'Post deleted' });
});

// –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/api/admin/users', authenticateToken, requireRole('admin'), (req, res) => {
  res.json({ message: 'All users list' });
});

app.delete('/api/admin/users/:id', authenticateToken, requireRole('admin'), (req, res) => {
  res.json({ message: 'User deleted' });
});

// –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/api/moderator/content', authenticateToken, requireRole(['admin', 'moderator']), (req, res) => {
  res.json({ message: 'Moderator content' });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Something went wrong!' });
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

---

## üéØ –ò—Ç–æ–≥

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –≤ REST API —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞, –≤–∫–ª—é—á–∞—é—â–µ–≥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, —Ä–æ–ª–µ–≤—É—é –º–æ–¥–µ–ª—å –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–π—Ç–µ —Ä–æ–ª–µ–≤—É—é –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
- ‚úÖ –§–∏–ª—å—Ç—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ middleware –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø –ø–æ IP –∏ CORS
- ‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üèÜ –ó–ê–î–ê–ß–ò

–ó–∞–¥–∞—á–∏ –ø–æ —Ç–µ–º–µ `–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –≤ REST API`:

---

### üìå –ó–∞–¥–∞—á–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
–°–æ–∑–¥–∞–π—Ç–µ middleware, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const requireRole = (roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }
    
    const userRole = req.user.role;
    const allowedRoles = Array.isArray(roles) ? roles : [roles];
    
    if (!allowedRoles.includes(userRole)) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    
    next();
  };
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
app.get('/api/admin/users', authenticateToken, requireRole('admin'), (req, res) => {
  res.json({ users: [] });
});

app.get('/api/moderator/content', authenticateToken, requireRole(['admin', 'moderator']), (req, res) => {
  res.json({ content: [] });
});
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞
–°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ä–µ—Å—É—Ä—Å–∞.

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const requireOwnership = (resourceType) => {
  return async (req, res, next) => {
    const resourceId = req.params.id;
    const userId = req.user.id;
    
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Å—É—Ä—Å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      const resource = await Resource.findById(resourceId);
      
      if (!resource) {
        return res.status(404).json({ error: 'Resource not found' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
      if (req.user.role !== 'admin' && resource.userId !== userId) {
        return res.status(403).json({ error: 'Access denied' });
      }
      
      req.resource = resource;
      next();
    } catch (error) {
      return res.status(500).json({ error: 'Server error' });
    }
  };
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
app.put('/api/posts/:id', authenticateToken, requireOwnership('post'), (req, res) => {
  res.json({ message: 'Post updated', resource: req.resource });
});
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 3: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–æ–ª—è–º
–°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const filterDataByRole = (userRole, userId) => {
  const filters = {
    admin: {}, // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    moderator: {
      $or: [
        { isPublic: true },
        { userId: userId }
      ]
    },
    user: { userId: userId } // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
  };
  
  return filters[userRole] || { userId: userId };
};

const getUserPosts = async (req, res) => {
  const userId = req.user.id;
  const userRole = req.user.role;
  
  try {
    const filter = filterDataByRole(userRole, userId);
    const posts = await Post.find(filter);
    res.json(posts);
  } catch (error) {
    res.status(500).json({ error: 'Server error' });
  }
};
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 4: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ HTTP –º–µ—Ç–æ–¥–æ–≤
–°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º HTTP –º–µ—Ç–æ–¥–∞–º.

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const allowedMethods = {
  '/api/posts': ['GET', 'POST'],
  '/api/posts/:id': ['GET', 'PUT', 'DELETE'],
  '/api/admin/users': ['GET', 'POST', 'PUT', 'DELETE']
};

const checkMethod = (req, res, next) => {
  const path = req.route?.path || req.path;
  const method = req.method;
  
  const allowed = allowedMethods[path];
  if (allowed && !allowed.includes(method)) {
    return res.status(405).json({ 
      error: `Method ${method} not allowed for ${path}` 
    });
  }
  
  next();
};

app.use(checkMethod);
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 5: IP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
–°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ IP-–∞–¥—Ä–µ—Å–∞–º.

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const allowedIPs = ['192.168.1.1', '10.0.0.1', '127.0.0.1'];

const checkIP = (req, res, next) => {
  const clientIP = req.ip || req.connection.remoteAddress;
  
  if (!allowedIPs.includes(clientIP)) {
    return res.status(403).json({ 
      error: 'IP not allowed',
      clientIP: clientIP 
    });
  }
  
  next();
};

// –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º
app.use('/api/admin', checkIP);
```

</details>

---

### üìå –ó–∞–¥–∞—á–∞ 6: –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –¥–æ—Å—Ç—É–ø–∞.

<details>
<summary>‚úç –†–µ—à–µ–Ω–∏–µ</summary>

```javascript
const permissions = {
  user: {
    posts: ['read:own', 'write:own'],
    comments: ['read:public', 'write:own']
  },
  moderator: {
    posts: ['read:all', 'write:own', 'moderate:content'],
    comments: ['read:all', 'write:own', 'moderate:content'],
    users: ['read:all']
  },
  admin: {
    posts: ['read:all', 'write:all', 'delete:all'],
    comments: ['read:all', 'write:all', 'delete:all'],
    users: ['read:all', 'write:all', 'delete:all']
  }
};

const checkPermission = (resource, action) => {
  return (req, res, next) => {
    const userRole = req.user.role;
    const userPermissions = permissions[userRole] || {};
    const resourcePermissions = userPermissions[resource] || [];
    
    if (!resourcePermissions.includes(action)) {
      return res.status(403).json({ 
        error: `Permission denied: ${action} on ${resource}` 
      });
    }
    
    next();
  };
};

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
app.get('/api/posts', authenticateToken, checkPermission('posts', 'read:all'), (req, res) => {
  res.json({ posts: [] });
});
```

</details>

---

üéâ –≠—Ç–∏ –∑–∞–¥–∞—á–∏ –ø–æ–º–æ–≥—É—Ç –∑–∞–∫—Ä–µ–ø–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –≤ REST API –∏ –Ω–∞—É—á–∏—Ç—å—Å—è –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ!

--- 